name: 'Setup Build Environment'
description: 'Setup common build environment for Desktop app workflows (expects repositories already checked out)'
inputs:
  node-version:
    description: 'Node.js version to use'
    required: false
    default: '22'
  core-ref:
    description: 'Core repository branch/ref to checkout'
    required: false
    default: 'enh/sdk-updates'
  os:
    description: 'Operating system (for Windows-specific handling)'
    required: false
    default: 'ubuntu-latest'
  skip-debug:
    description: 'Skip debug directory structure step'
    required: false
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: Debug directory structure
      if: ${{ inputs.skip-debug != 'true' }}
      shell: bash
      run: |
        echo "=== Current working directory ==="
        pwd
        echo "=== Directory structure ==="
        find datalayer -type d -maxdepth 3 || true
        echo "=== Core repository contents ==="
        ls -la datalayer/core/ || echo "Core directory not found"
        echo "=== Looking for lib directory ==="
        find datalayer/core -name "lib" -type d || echo "No lib directory found"
        echo "=== Looking for built SDK files ==="
        find datalayer/core -path "*/lib/sdk*" -type f | head -10 || echo "No built SDK files found"

    - name: Install core repository dependencies and build
      shell: bash
      working-directory: datalayer/core
      run: |
        echo "Installing core dependencies..."
        npm install --ignore-scripts
        echo "Building core SDK (required for Desktop app)..."
        export NODE_OPTIONS="--max-old-space-size=8192"
        npm run build
        echo "Core build completed successfully!"

    - name: Setup Node.js ${{ inputs.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}

    - name: Install desktop dependencies
      shell: bash
      working-directory: datalayer/desktop
      run: |
        if [ "${{ inputs.os }}" == "windows-latest" ]; then
          echo "Installing on Windows with --force flag to bypass OS restrictions"
          npm install --force
        else
          npm install
        fi
